<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  {% set page_title = (query ~ " ‚Äì Risultati | RetroFuture Search") if query else "Risultati | RetroFuture Search" %}
  <title>{{ page_title }}</title>

  <meta name="description" content="Risultati per '{{ query }}' su RetroFuture Search: sfoglia oggetti vintage da pi√π marketplace.">
  <meta name="robots" content="noindex, follow">

  <link rel="canonical" href="{{ url_for('search',
      q=query, era=era, category=category, source=source,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page, _external=True) }}">

  {% if page and page>1 %}
  <link rel="prev" href="{{ url_for('search',
      q=query, era=era, category=category, source=source,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page-1, _external=True) }}">
  {% endif %}
  {% if risultati|length == 50 %}
  <link rel="next" href="{{ url_for('search',
      q=query, era=era, category=category, source=source,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page+1, _external=True) }}">
  {% endif %}

  <!-- ‚úÖ Font (alternativa legale/semplice ai loghi) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:auto; }
    body{
      font-family: system-ui, Arial, sans-serif;
      margin:0;
      background:#f4f4f4;
    }
    #rf-root{ padding: 10px 10px 14px; }
    a{ text-decoration:none; color:inherit; }

    /* ‚úÖ TOPBAR (ultra compatta) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fff;
      border:1px solid #e9e9e9;
      border-radius:12px;
      padding:6px 10px;
      box-shadow:0 1px 4px rgba(0,0,0,0.04);
      margin-bottom:8px;
    }
    .topbar-left{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }
    .topbar-title{
      font-size:15px;
      font-weight:900;
      color:#111;
      letter-spacing:-0.2px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      height:22px;
      padding:0 9px;
      border-radius:999px;
      font-size:12.5px;
      border:1px solid #e6e6e6;
      background:#fafafa;
      color:#333;
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .chip-query{
      border-color: rgba(0,170,119,.25);
      background: rgba(0,170,119,.08);
      color:#066;
      font-weight:900;
    }
    .chip-muted{ color:#666; }
    .chip-admin{
      border-style:dashed;
      color:#666;
      background:#fff;
      user-select:none;
    }
    .chip-count{
      border-color:#ddd;
      background:#f3f3f3;
      color:#111;
      font-weight:900;
    }

    .topbar-right{ flex:0 0 auto; }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:28px;
      padding:0 10px;
      border-radius:9px;
      font-weight:900;
      border:1px solid #ddd;
      background:#fff;
      color:#111;
      white-space:nowrap;
      font-size:12.5px;
    }
    .btn:hover{ background:#f6f6f6; border-color:#ccc; }

    /* ‚úÖ CARD CONTROLLO */
    .control-card{
      background:#fff;
      border:1px solid #eee;
      border-radius:12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.04);
      padding:8px;
      margin-bottom:8px;
    }
    .control-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .search-row{ margin-bottom:6px; }
    .filters-row{
      padding-top:6px;
      border-top:1px solid #f1f1f1;
      justify-content:flex-start;
      gap:8px;
    }
    .q-wrap{
      flex: 1 1 560px;
      min-width:260px;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .field{
      flex: 0 1 140px;
      min-width:120px;
      display:flex;
    }
    .field-wide{
      flex: 0 1 190px;
      min-width:150px;
    }
    .price-field{ max-width: 105px; }

    input, select{
      height:28px;
      padding:0 9px;
      border:1px solid #cfcfcf;
      border-radius:9px;
      background:#fff;
      width:100%;
      font-size:13px;
    }
    .q-wrap input{
      flex: 1 1 auto;
      min-width:240px;
    }
    button{
      height:28px;
      padding:0 12px;
      border:none;
      background:#0a7;
      color:#fff;
      border-radius:9px;
      cursor:pointer;
      font-weight:900;
      white-space:nowrap;
      font-size:13px;
    }
    button:hover{ background:#088; }
    button[disabled]{ opacity:.55; cursor:not-allowed; }

    /* ‚úÖ Altri risultati */
    .external-inline{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid #f1f1f1;
      font-size:13px;
      color:#333;
    }
    .external-left{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      min-width:0;
    }
    .ext-label{
      font-weight:900;
      color:#444;
      white-space:nowrap;
    }

    /* ‚úÖ Bottoni esterni: testo bianco + sfondo brand */
    .ext-pill{
      height:28px;
      width: 150px;
      justify-content:center;
      padding:0 36px 0 36px;
      border-radius:999px;
      border:1px solid transparent;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .12s, filter .12s, box-shadow .12s, border-color .12s;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    }
    .ext-pill:hover{
      transform: translateY(-1px);
      filter: brightness(0.98);
      box-shadow: 0 10px 18px rgba(0,0,0,0.12);
    }
    .ext-pill:focus-visible{
      outline: none;
      box-shadow: 0 0 0 3px rgba(10,170,119,.25), 0 10px 18px rgba(0,0,0,0.12);
    }

    .ext-text{
      font-size:14px;
      font-weight:900;
      line-height:1;
      display:inline-block;
      transform: translateY(0.5px);
      color:#fff;
      text-shadow: 0 1px 0 rgba(0,0,0,0.10);
    }

    /* ‚úÖ Facebook */
    .ext-facebook{
      background:#1877F2;
      border-color:#166fe5;
    }
    .ext-facebook .ext-text{
      font-family: "Inter", system-ui, sans-serif;
      letter-spacing:-0.2px;
    }

    /* ‚úÖ Wallapop */
    .ext-wallapop{
      background:#00C4A7;
      border-color:#00b095;
    }
    .ext-wallapop .ext-text{
      font-family: "Poppins", system-ui, sans-serif;
      letter-spacing:-0.2px;
      text-transform: lowercase;
    }

    /* ‚úÖ freccia: badge leggibile su qualsiasi colore */
    .ext-arrow{
      font-size:10px;
      font-weight:900;
      line-height:1;
      padding:2px 6px;
      border-radius:999px;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.35);
      color:#fff;
      pointer-events:none;
      margin-left: 6px;
      text-shadow: 0 1px 0 rgba(0,0,0,0.10);
    }

    .ext-note{
      font-size:11.5px;
      color:#777;
      white-space:nowrap;
    }

    /* admin pills */
    .pillbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 8px 0 10px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      font-size:13px;
      font-weight:800;
    }
    .pill.active{ border-color:#0a7; color:#0a7; font-weight:900; }

    .admin-only{ display:none; }
    body.admin .admin-only{ display:flex !important; }
    body.admin .admin-only-inline{ display:inline-flex !important; }
    .admin-only-inline{ display:none; }

    /* grid cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
      gap:14px;
    }
    .card{
      position:relative;
      background:#fff;
      border-radius:12px;
      padding:10px;
      box-shadow:0 2px 6px rgba(0,0,0,.08);
      transition:transform .15s;
    }
    .card:hover{ transform:translateY(-2px); }

    .remove-btn{
      position:absolute;
      top:6px;
      right:6px;
      background:#d9534f;
      border:none;
      color:white;
      padding:4px 8px;
      border-radius:8px;
      font-size:12px;
      cursor:pointer;
      display:none;
      opacity:0.85;
      z-index:2;
      height:auto;
    }
    .remove-btn:hover{ opacity:1; background:#c9302c; }
    body.admin .remove-btn{ display:block !important; }

    .thumb{
      width:100%;
      height:180px;
      object-fit:cover;
      border-radius:10px;
      background:#eee;
    }
    .title{
      margin:8px 0 4px;
      font-weight:700;
      font-size:14px;
      color:#222;
      line-height:1.3;
      height:38px;
      overflow:hidden;
    }
    .price{ color:#0a7; font-weight:900; margin-bottom:6px; }
    .meta{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .logo{ height:22px; width:78px; object-fit:contain; opacity:.85; display:block; }

    .pagination{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:18px;
      align-items:center;
    }
    .pagination a{
      padding:8px 14px;
      border-radius:10px;
      background:white;
      border:1px solid #ddd;
      font-weight:900;
    }

    @media (max-width: 520px){
      #rf-root{ padding:10px 9px 14px; }
      .topbar{ align-items:flex-start; }
      .topbar-right{ width:100%; }
      .btn{ width:100%; }

      .q-wrap{ flex: 1 1 100%; }
      .field{ min-width:46%; flex: 1 1 46%; }
      .field-wide{ min-width: 100%; flex: 1 1 100%; }
      .price-field{ max-width:none; }

      .external-inline{ align-items:flex-start; }
      .ext-note{ white-space:normal; }

      .ext-pill{ width: 190px; height:30px; }
      .ext-text{ font-size:13px; }
    }
  </style>

  <script>
    document.addEventListener("keydown", e => {
      if (e.altKey && e.key.toLowerCase() === "a") {
        document.body.classList.toggle("admin");
        alert("Admin mode " + (document.body.classList.contains("admin") ? "ATTIVA ‚úÖ" : "OFF ‚ùå"));
      }
    });

    function removeItem(hash, title){
      if(!confirm("Eliminare e addestrare su questo oggetto?\n\n" + title)) return;

      fetch("/remove_item", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({hash, title})
      })
      .then(r=>r.json())
      .then(res=>{
        if(res.status==="ok"){
          document.getElementById(hash)?.remove();
        } else {
          alert("Errore: "+(res.msg || "operazione non riuscita"));
        }
      });
    }
  </script>
</head>

<body>
  <div id="rf-root">

    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">Risultati</div>

        {% if query %}
          <span class="chip chip-query">{{ query }}</span>
        {% else %}
          <span class="chip chip-muted">tutto</span>
        {% endif %}

        <span class="chip chip-count">
          {{ risultati|length }} {{ 'risultato' if risultati|length == 1 else 'risultati' }}
        </span>

        <span class="chip chip-admin admin-only-inline">ALT+A</span>
      </div>

      <div class="topbar-right">
        <a href="/" class="btn">Nuova ricerca</a>
      </div>
    </div>

    <div class="pillbar admin-only">
      <a class="pill {% if scope=='tutti' %}active{% endif %}"
         href="{{ url_for('search',
           q=None, era=None, category=None, source=None,
           price_min=None, price_max=None, sort='date', scope='tutti', page=1) }}">
        üëÅÔ∏è Mostra tutti
      </a>

      <a class="pill {% if not scope or scope!='tutti' %}active{% endif %}"
         href="{{ url_for('search',
           q=query or '', era=era or '', category=category or '', source=source or '',
           price_min=price_min, price_max=price_max,
           sort=sort or 'score', scope=None, page=1) }}">
        üîé Ricerca filtrata
      </a>
    </div>

    <div class="control-card">
      <form method="get" action="/search">
        <div class="control-row search-row">
          <div class="q-wrap">
            <input type="text" name="q" placeholder="Cerca un altro prodotto..." value="{{ query }}">
            <input type="hidden" name="scope" value="{{ scope }}">
            <button type="submit">Cerca</button>
          </div>
        </div>
      </form>

      <form method="get" action="/search">
        <div class="control-row filters-row">
          <input type="hidden" name="q" value="{{ query }}">
          <input type="hidden" name="scope" value="{{ scope }}">

          <div class="field">
            <select name="era" {% if scope=='tutti' %}disabled{% endif %}>
              <option value="">Epoca</option>
              {% for e in ['anni_50','anni_60','anni_70','anni_80','anni_90','anni_2000'] %}
              <option value="{{e}}" {% if era==e %}selected{% endif %}>{{e.replace('_',' ')}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="field field-wide">
            <select name="category" {% if scope=='tutti' %}disabled{% endif %}>
              <option value="">Categoria</option>

              <option value="tecnologia" {% if category=='tecnologia' %}selected{% endif %}>Tecnologia</option>
              <option value="arredamento" {% if category=='arredamento' %}selected{% endif %}>Arredamento</option>
              <option value="moda_accessori" {% if category=='moda_accessori' %}selected{% endif %}>Moda &amp; Accessori</option>
              <option value="giochi_giocattoli" {% if category=='giochi_giocattoli' %}selected{% endif %}>Giochi &amp; Giocattoli</option>
              <option value="musica_cinema" {% if category=='musica_cinema' %}selected{% endif %}>Musica &amp; Cinema</option>
              <option value="auto_moto" {% if category=='auto_moto' %}selected{% endif %}>Auto &amp; Moto</option>
              <option value="libri_fumetti" {% if category=='libri_fumetti' %}selected{% endif %}>Libri &amp; Fumetti</option>
              <option value="cucina" {% if category=='cucina' %}selected{% endif %}>Cucina</option>
              <option value="cartoleria" {% if category=='cartoleria' %}selected{% endif %}>Cartoleria</option>
              <option value="collezionismo" {% if category=='collezionismo' %}selected{% endif %}>Collezionismo</option>
            </select>
          </div>

          <!-- ‚úÖ Marketplace -->
          <div class="field">
            <select name="source" {% if scope=='tutti' %}disabled{% endif %}>
              <option value="">Marketplace</option>
              <option value="ebay" {% if source=='ebay' %}selected{% endif %}>eBay</option>
              <option value="vinted" {% if source=='vinted' %}selected{% endif %}>Vinted</option>
              <option value="subito" {% if source=='subito' %}selected{% endif %}>Subito</option>
              <option value="mercatino" {% if source=='mercatino' %}selected{% endif %}>Mercatino</option>
            </select>
          </div>

          <div class="field">
            <input class="price-field" type="number" step="0.01" name="price_min" placeholder="Min ‚Ç¨"
                   value="{{ price_min }}" {% if scope=='tutti' %}disabled{% endif %}>
          </div>

          <div class="field">
            <input class="price-field" type="number" step="0.01" name="price_max" placeholder="Max ‚Ç¨"
                   value="{{ price_max }}" {% if scope=='tutti' %}disabled{% endif %}>
          </div>

          <div class="field">
            <select name="sort" {% if scope=='tutti' %}disabled{% endif %}>
              <option value="score" {% if sort=='score' %}selected{% endif %}>Migliori</option>
              <option value="date" {% if sort=='date' %}selected{% endif %}>Aggiunti di recente</option>
              <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Prezzo ‚Üë</option>
              <option value="price_desc" {% if sort=='price_desc' %}selected{% endif %}>Prezzo ‚Üì</option>
            </select>
          </div>

          <button type="submit" {% if scope=='tutti' %}disabled{% endif %}>Applica</button>
        </div>
      </form>

      {% if query %}
        <div class="external-inline">
          <div class="external-left">
            <span class="ext-label">Altri risultati:</span>

           <a class="ext-pill ext-facebook" target="_blank" rel="noopener"
               href="https://www.facebook.com/marketplace/np/rome/search/?query={{ query|default('vintage')|urlencode }}&radius=500"
               aria-label="Apri su Facebook Marketplace">
             <span class="ext-text">facebook marketplace</span>
             <span class="ext-arrow">‚Üó</span>
           </a>



            <a class="ext-pill ext-wallapop" target="_blank" rel="noopener"
               href="https://it.wallapop.com/app/search?keywords={{ query|urlencode }}"
               aria-label="Apri su Wallapop">
              <span class="ext-text">wallapop</span>
              <span class="ext-arrow">‚Üó</span>
            </a>
          </div>

          <div class="ext-note">siti esterni ‚Ä¢ marchi dei rispettivi proprietari</div>
        </div>
      {% endif %}
    </div>

    <div class="grid" id="rf-grid">
      {% for r in risultati %}
      <div class="card" id="{{ r.hash }}">
        <button class="remove-btn"
          onclick="removeItem('{{ r.hash }}', '{{ r.title or r.titolo }}')">üóëÔ∏è</button>

        <a href="{{ r.url or r.link }}" target="_blank" rel="noopener">
          <img class="thumb"
               src="{{ r.image or r.immagine or 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg' }}"
               alt="{{ r.title or r.titolo }}"
               loading="lazy" />

          <div class="title">{{ r.title or r.titolo or 'Titolo non disponibile' }}</div>

          <div class="price">
            {% if r.price_display %}
              {{ r.price_display }}
            {% elif r.price_value %}
              {{ "%.2f"|format(r.price_value|float) }} EUR
            {% else %}
              Prezzo non disponibile
            {% endif %}
          </div>

          <div class="meta">
            {% if r.source %}
              <img class="logo" src="/static/loghi/{{ r.source|lower }}.png" alt="{{ r.source }}">
            {% endif %}
          </div>
        </a>
      </div>
      {% endfor %}
    </div>

    <div class="pagination">
      {% if page > 1 %}
        <a href="{{ url_for('search',
          q=query, era=era, category=category, source=source,
          price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page-1) }}">‚Üê Precedente</a>
      {% endif %}
      <span>Pagina {{ page }}</span>
      {% if risultati|length == 50 %}
        <a href="{{ url_for('search',
          q=query, era=era, category=category, source=source,
          price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page+1) }}">Successiva ‚Üí</a>
      {% endif %}
    </div>

  </div>

  <!-- ‚úÖ Altezza iframe: misura SOLO #rf-root -->
  <script>
(function () {
  if (window.self === window.top) return;

  const root = document.getElementById("rf-root");
  if (!root) return;

  let targetOrigin = "*";
  try {
    if (document.referrer) targetOrigin = new URL(document.referrer).origin;
  } catch (e) {}

  let rafId = null;
  let lastSent = 0;
  let lastH = 0;

  function getContentHeight() {
  // misura reale: top di #rf-root ‚Üí bottom dell‚Äôultimo elemento dentro #rf-root
  const rootRect = root.getBoundingClientRect();
  const last = root.lastElementChild;
  if (!last) return 0;

  const lastRect = last.getBoundingClientRect();
  const h = lastRect.bottom - rootRect.top;

  return Math.max(1, Math.ceil(h));
}


  function postHeight(force) {
    const now = Date.now();
    if (!force && (now - lastSent) < 120) return;

    const h = getContentHeight();
    if (!force && Math.abs(h - lastH) < 2) return;

    lastSent = now;
    lastH = h;
    window.parent.postMessage({ rf_height: h }, targetOrigin);
  }

  function schedule(force) {
    if (rafId) cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(() => postHeight(!!force));
  }

  schedule(true);
  setTimeout(() => schedule(true), 120);
  setTimeout(() => schedule(true), 400);
  setTimeout(() => schedule(true), 900);

  window.addEventListener("load", () => schedule(true));
  window.addEventListener("resize", () => schedule(false));

  function hookImages() {
    root.querySelectorAll("img").forEach(img => {
      if (img.dataset.rfHooked) return;
      img.dataset.rfHooked = "1";
      img.addEventListener("load", () => schedule(true));
      img.addEventListener("error", () => schedule(true));
    });
  }
  hookImages();

  const mo = new MutationObserver(() => {
    hookImages();
    schedule(false);
  });
  mo.observe(root, { childList: true, subtree: true, attributes: true });

  if (window.ResizeObserver) {
    const ro = new ResizeObserver(() => schedule(false));
    ro.observe(root);
  }

  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(() => schedule(true)).catch(()=>{});
  }
})();
</script>


</body>
</html>
