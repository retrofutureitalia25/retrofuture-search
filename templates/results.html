<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  {% set page_title = (query ~ " ‚Äì Risultati | RetroFuture Search") if query else "Risultati | RetroFuture Search" %}
  <title>{{ page_title }}</title>

  <meta name="description" content="Risultati per '{{ query }}' su RetroFuture Search: sfoglia oggetti vintage da pi√π marketplace.">
  <meta name="robots" content="noindex, follow">

  <link rel="canonical" href="{{ url_for('search',
      q=query, era=era, vintage_class=vintage_class, category=category,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page, _external=True) }}">

  {% if page and page>1 %}
  <link rel="prev" href="{{ url_for('search',
      q=query, era=era, vintage_class=vintage_class, category=category,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page-1, _external=True) }}">
  {% endif %}
  {% if risultati|length == 50 %}
  <link rel="next" href="{{ url_for('search',
      q=query, era=era, vintage_class=vintage_class, category=category,
      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page+1, _external=True) }}">
  {% endif %}

  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background: #f4f4f4; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 16px; }

    .card { position:relative; background: #fff; border-radius: 12px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,.08); transition: transform .15s; }
    .card:hover { transform: translateY(-2px); }

    /* pulsante admin */
    .remove-btn {
      position:absolute;
      top:6px;
      right:6px;
      background:#d9534f;
      border:none;
      color:white;
      padding:4px 8px;
      border-radius:6px;
      font-size:12px;
      cursor:pointer;
      display:none;
      opacity:0.8;
      z-index: 2;
    }
    .remove-btn:hover { opacity:1; background:#c9302c; }
    body.admin .remove-btn { display:block !important; }

    .thumb { width: 100%; height: 180px; object-fit: cover; border-radius: 8px; background: #eee; }
    .title { margin: 8px 0 4px; font-weight: 600; font-size: 14px; color: #222; line-height: 1.3; height: 38px; overflow: hidden; }
    .price { color: #0a7; font-weight: 700; margin-bottom: 6px; }

    .meta { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .logo {
      height: 22px;
      width: 78px;
      object-fit: contain;
      opacity: .85;
      display: block;
    }

    .dim { color:#666; font-size:12px; }
    a { text-decoration: none; color: inherit; }

    .toolbar, form.filters, form.searchbar { display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;align-items:center; }
    form.filters, form.searchbar {
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
    }
    select,input { padding:6px 8px;border:1px solid #ccc;border-radius:6px; }
    button { padding:6px 10px;border:none;background:#0a7;color:#fff;border-radius:6px;cursor:pointer; }
    button:hover { background:#088; }
    .back { padding:8px 12px;background:#fff;border-radius:8px;border:1px solid #ddd;color:#333; }

    .pillbar { display:flex; flex-wrap:wrap; gap:8px; margin: 8px 0 16px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid #ddd; background:#fff; border-radius:999px; font-size:14px; }
    .pill.active { border-color:#0a7; color:#0a7; font-weight:600; }

    .admin-only { display:none; }
    body.admin .admin-only { display:flex !important; }

    .pagination { display:flex;justify-content:center;gap:10px;margin-top:32px; align-items:center; }
    .pagination a { padding:8px 14px;border-radius:8px;background:white;border:1px solid #ddd; }

    /* riga compatta "cerca anche su" */
    .external-search-line{
      margin: 6px 0 14px;
      font-size:14px;
      color:#444;
      background:#fff;
      border:1px solid #e6e6e6;
      border-radius:10px;
      padding:10px 12px;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
    }
    .external-search-line a{
      font-weight:700;
      color:#0a7;
    }
    .external-search-line a:hover{
      text-decoration: underline;
    }
    .external-note{
      font-size:12px;
      color:#777;
      margin-top:4px;
      line-height:1.4;
    }
  </style>

  <script>
  document.addEventListener("keydown", e => {
    if (e.altKey && e.key.toLowerCase() === "a") {
      document.body.classList.toggle("admin");
      alert("Admin mode " + (document.body.classList.contains("admin") ? "ATTIVA ‚úÖ" : "OFF ‚ùå"));
    }
  });

  function removeItem(hash, title){
    if(!confirm("Eliminare e addestrare su questo oggetto?\n\n" + title)) return;

    fetch("/remove_item", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({hash, title})
    })
    .then(r=>r.json())
    .then(res=>{
      if(res.status==="ok"){
        document.getElementById(hash)?.remove();
      } else {
        alert("Errore: "+(res.msg || "operazione non riuscita"));
      }
    });
  }
  </script>
</head>

<body>

  <div class="toolbar">
    <a href="/" class="back">‚Üê Nuova ricerca</a>
    <div>Risultati per: <strong>{{ query or 'tutto' }}</strong></div>
    <div class="dim">Premi <b>ALT+A</b> per admin mode</div>
  </div>

  <!-- pillbar visibile solo in admin -->
  <div class="pillbar admin-only">
    <a class="pill {% if scope=='tutti' %}active{% endif %}"
       href="{{ url_for('search',
         q=None, era=None, vintage_class=None, category=None,
         price_min=None, price_max=None, sort='added', scope='tutti', page=1) }}">
      üëÅÔ∏è Mostra tutti
    </a>

    <a class="pill {% if not scope or scope!='tutti' %}active{% endif %}"
       href="{{ url_for('search',
         q=query or '', era=era or '', vintage_class=vintage_class or '',
         category=category or '', price_min=price_min, price_max=price_max,
         sort=sort or 'score', scope=None, page=1) }}">
      üîé Ricerca filtrata
    </a>
  </div>

  <form method="get" action="/search" class="searchbar">
    <input type="text" name="q" placeholder="Cerca un altro prodotto..." value="{{ query }}">
    <input type="hidden" name="scope" value="{{ scope }}">
    <button type="submit">Cerca</button>
  </form>

  <form method="get" action="/search" class="filters">
    <input type="hidden" name="q" value="{{ query }}">
    <input type="hidden" name="scope" value="{{ scope }}">

    <select name="era" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Epoca</option>
      {% for e in ['anni_50','anni_60','anni_70','anni_80','anni_90','vintage_generico'] %}
      <option value="{{e}}" {% if era==e %}selected{% endif %}>{{e.replace('_',' ')}}</option>
      {% endfor %}
    </select>

    <select name="vintage_class" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Classe Vintage</option>
      <option value="strong_vintage" {% if vintage_class=='strong_vintage' %}selected{% endif %}>Strong</option>
      <option value="vintage" {% if vintage_class=='vintage' %}selected{% endif %}>Vintage</option>
    </select>

    <select name="category" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Categoria</option>
      <option value="arredamento" {% if category=='arredamento' %}selected{% endif %}>Arredamento</option>
      <option value="moda" {% if category=='moda' %}selected{% endif %}>Moda</option>
      <option value="tecnologia" {% if category=='tecnologia' %}selected{% endif %}>Tecnologia</option>
      <option value="collezionismo" {% if category=='collezionismo' %}selected{% endif %}>Collezionismo</option>
      <option value="vario" {% if category=='vario' %}selected{% endif %}>Altro</option>
    </select>

    <input type="number" step="0.01" name="price_min" placeholder="Min ‚Ç¨" value="{{ price_min }}" {% if scope=='tutti' %}disabled{% endif %}>
    <input type="number" step="0.01" name="price_max" placeholder="Max ‚Ç¨" value="{{ price_max }}" {% if scope=='tutti' %}disabled{% endif %}>

    <select name="sort" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="score" {% if sort=='score' %}selected{% endif %}>Migliori risultati</option>
      <option value="date" {% if sort=='date' %}selected{% endif %}>Pi√π recenti (aggiornati)</option>
      <option value="added" {% if sort=='added' %}selected{% endif %}>Pi√π recenti (aggiunti)</option>
      <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Prezzo crescente</option>
      <option value="price_desc" {% if sort=='price_desc' %}selected{% endif %}>Prezzo decrescente</option>
    </select>

    <button type="submit" {% if scope=='tutti' %}disabled{% endif %}>Applica</button>
  </form>

  <div class="results-count">
    {{ risultati|length }} risultati trovati
  </div>

  {% if query %}
    <div class="external-search-line">
      üîé Vuoi pi√π risultati? Cerca anche su:
      <a target="_blank" rel="noopener"
         href="https://www.facebook.com/marketplace/search/?query={{ query|urlencode }}">
        Facebook Marketplace ‚Üó
      </a>
      ¬∑
      <a target="_blank" rel="noopener"
         href="https://it.wallapop.com/app/search?keywords={{ query|urlencode }}">
        Wallapop ‚Üó
      </a>
      <div class="external-note">Nota: ricerca su siti esterni.</div>
    </div>
  {% endif %}

  <div class="grid" id="rf-grid">
    {% for r in risultati %}
    <div class="card" id="{{ r.hash }}">
      <button class="remove-btn"
        onclick="removeItem('{{ r.hash }}', '{{ r.title or r.titolo }}')">üóëÔ∏è</button>

      <a href="{{ r.url or r.link }}" target="_blank" rel="noopener">
        <img class="thumb"
             src="{{ r.image or r.immagine or 'https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg' }}"
             alt="{{ r.title or r.titolo }}"
             loading="lazy" />

        <div class="title">{{ r.title or r.titolo or 'Titolo non disponibile' }}</div>

        <div class="price">
          {% if r.price_display %}
            {{ r.price_display }}
          {% elif r.price_value %}
            {{ "%.2f"|format(r.price_value|float) }} EUR
          {% else %}
            Prezzo non disponibile
          {% endif %}
        </div>

        <div class="meta">
          {% if r.source %}
            <img class="logo" src="/static/loghi/{{ r.source|lower }}.png" alt="{{ r.source }}">
          {% endif %}
        </div>
      </a>
    </div>
    {% endfor %}
  </div>

  <div class="pagination">
    {% if page > 1 %}
      <a href="{{ url_for('search',
        q=query, era=era, vintage_class=vintage_class, category=category,
        price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page-1) }}">‚Üê Precedente</a>
    {% endif %}
    <span>Pagina {{ page }}</span>
    {% if risultati|length == 50 %}
      <a href="{{ url_for('search',
        q=query, era=era, vintage_class=vintage_class, category=category,
        price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page+1) }}">Successiva ‚Üí</a>
    {% endif %}
  </div>

  <!-- ‚úÖ SCRIPT DEFINITIVO: invia altezza al parent (WordPress iframe) -->
  <script>
  (function () {
    // Se la pagina NON √® in iframe, non fare nulla
    if (window.self === window.top) return;

    // targetOrigin: prova a ricavarlo dal referrer (pi√π sicuro), altrimenti usa "*"
    let targetOrigin = "*";
    try {
      if (document.referrer) {
        targetOrigin = new URL(document.referrer).origin;
      }
    } catch (e) {}

    let lastSent = 0;
    let rafId = null;

    function getDocHeight() {
      const doc = document.documentElement;
      const body = document.body;
      return Math.max(
        body.scrollHeight, doc.scrollHeight,
        body.offsetHeight, doc.offsetHeight,
        body.clientHeight, doc.clientHeight
      );
    }

    function postHeight(force) {
      const now = Date.now();
      if (!force && (now - lastSent) < 120) return; // throttle
      lastSent = now;

      const h = getDocHeight();
      window.parent.postMessage({ rf_height: h }, targetOrigin);
    }

    function schedule(force) {
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(() => postHeight(!!force));
    }

    // 1) subito + dopo un attimo
    schedule(true);
    setTimeout(() => schedule(true), 120);
    setTimeout(() => schedule(true), 400);
    setTimeout(() => schedule(true), 900);

    // 2) onload
    window.addEventListener("load", () => schedule(true));

    // 3) resize (viewport cambia)
    window.addEventListener("resize", () => schedule(false));

    // 4) quando finiscono di caricare le immagini (lazy compreso)
    function hookImages() {
      const imgs = document.querySelectorAll("img");
      imgs.forEach(img => {
        if (img.dataset.rfHooked) return;
        img.dataset.rfHooked = "1";
        img.addEventListener("load", () => schedule(true));
        img.addEventListener("error", () => schedule(true));
      });
    }
    hookImages();

    // 5) osserva cambiamenti DOM (risultati/paginazione/filtri)
    const mo = new MutationObserver(() => {
      hookImages();
      schedule(false);
    });
    mo.observe(document.body, { childList: true, subtree: true, attributes: true });

    // 6) osserva cambiamenti di dimensione reali
    if (window.ResizeObserver) {
      const ro = new ResizeObserver(() => schedule(false));
      ro.observe(document.body);
    }

    // 7) font load pu√≤ cambiare altezza
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(() => schedule(true)).catch(()=>{});
    }

    // 8) safety ping (per casi strani di Elementor)
    setInterval(() => schedule(false), 2000);
  })();
  </script>

</body>
</html>

