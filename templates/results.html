<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  {% set page_title = (query ~ " ‚Äì Risultati | RetroFuture Search") if query else "Risultati | RetroFuture Search" %}
  <title>{{ page_title }}</title>

  <meta name="description" content="Risultati per '{{ query }}' su RetroFuture Search: sfoglia oggetti vintage da pi√π marketplace.">
  <meta name="robots" content="noindex, follow">

  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      background: #f4f4f4;
      font-family: system-ui, Arial, sans-serif;
    }

    #rf-wrapper {
      padding: 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      transition: transform .15s;
      position: relative;
    }
    .card:hover { transform: translateY(-2px); }

    .remove-btn {
      position:absolute;
      top:6px;
      right:6px;
      background:#d9534f;
      border:none;
      color:white;
      padding:4px 8px;
      border-radius:6px;
      font-size:12px;
      cursor:pointer;
      display:none;
      opacity:0.8;
    }
    body.admin-mode .remove-btn { display:block !important; }

    .thumb {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      background: #eee;
    }

    .title {
      margin: 8px 0 4px;
      font-weight: 600;
      font-size: 14px;
      color: #222;
      line-height: 1.3;
      height: 38px;
      overflow: hidden;
    }

    .price {
      color: #0a7;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .meta {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .logo {
      height: 22px;
      width: 78px; 
      object-fit: contain;
      opacity: .85;
      display: block;
    }
      opacity: .85;
      display: block;
    }

    .dim { color:#666; font-size:12px; }
    a { text-decoration: none; color: inherit; }

    .toolbar,
    form.filters,
    form.searchbar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:16px;
      align-items:center;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
    }

    select,input {
      padding:6px 8px;
      border:1px solid #ccc;
      border-radius:6px;
    }

    button {
      padding:6px 10px;
      border:none;
      background:#0a7;
      color:#fff;
      border-radius:6px;
      cursor:pointer;
    }
    button:hover { background:#088; }

    .back {
      padding:8px 12px;
      background:#fff;
      border-radius:8px;
      border:1px solid #ddd;
      color:#333;
    }

    .pillbar {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin: 8px 0 16px;
    }

    .pill {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      font-size:14px;
    }

    .pill.active {
      border-color:#0a7;
      color:#0a7;
      font-weight:600;
    }

    .admin-only { display:none; }
    body.admin-mode .admin-only { display:flex !important; }

    .pagination {
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:32px;
    }

    .pagination a {
      padding:8px 14px;
      border-radius:8px;
      background:white;
      border:1px solid #ddd;
    }
  </style>

</head>
<body>

<div id="rf-wrapper">

  <div class="toolbar">
    <a href="https://retrofutureitalia.it" target="_top" class="back">‚Üê Nuova ricerca</a>
    <div>Risultati per: <strong>{{ query or 'tutto' }}</strong></div>
    <div class="dim">Modalit√† admin disponibile</div>
  </div>

  <div class="pillbar admin-only">
    <a class="pill {% if scope=='tutti' %}active{% endif %}"
       href="{{ url_for('search', q=None, era=None, vintage_class=None, category=None, price_min=None, price_max=None, sort='added', scope='tutti', page=1) }}">
      üëÅÔ∏è Mostra tutti
    </a>

    <a class="pill {% if not scope or scope!='tutti' %}active{% endif %}"
       href="{{ url_for('search', q=query or '', era=era or '', vintage_class=vintage_class or '', category=category or '',
          price_min=price_min, price_max=price_max, sort=sort or 'score', scope=None, page=1) }}">
      üîé Ricerca filtrata
    </a>
  </div>

  <form method="get" action="/search" class="searchbar">
    <input type="text" name="q" placeholder="Cerca un altro prodotto..." value="{{ query }}">
    <input type="hidden" name="scope" value="{{ scope }}">
    <button type="submit">Cerca</button>
  </form>

  <form method="get" action="/search" class="filters">
    <input type="hidden" name="q" value="{{ query }}">
    <input type="hidden" name="scope" value="{{ scope }}">

    <select name="era" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Epoca</option>
      {% for e in ['anni_50','anni_60','anni_70','anni_80','anni_90','vintage_generico'] %}
      <option value="{{e}}" {% if era==e %}selected{% endif %}>{{e.replace('_',' ')}}</option>
      {% endfor %}
    </select>

    <select name="vintage_class" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Classe Vintage</option>
      <option value="strong_vintage" {% if vintage_class=='strong_vintage' %}selected{% endif %}>Strong</option>
      <option value="vintage" {% if vintage_class=='vintage' %}selected{% endif %}>Vintage</option>
    </select>

    <select name="category" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="">Categoria</option>
      <option value="arredamento" {% if category=='arredamento' %}selected{% endif %}>Arredamento</option>
      <option value="moda" {% if category=='moda' %}selected{% endif %}>Moda</option>
      <option value="tecnologia" {% if category=='tecnologia' %}selected{% endif %}>Tecnologia</option>
      <option value="collezionismo" {% if category=='collezionismo' %}selected{% endif %}>Collezionismo</option>
      <option value="vario" {% if category=='vario' %}selected{% endif %}>Altro</option>
    </select>

    <input type="number" step="0.01" name="price_min" placeholder="Min ‚Ç¨" value="{{ price_min }}" {% if scope=='tutti' %}disabled{% endif %}>
    <input type="number" step="0.01" name="price_max" placeholder="Max ‚Ç¨" value="{{ price_max }}" {% if scope=='tutti' %}disabled{% endif %}>

    <select name="sort" {% if scope=='tutti' %}disabled{% endif %}>
      <option value="score" {% if sort=='score' %}selected{% endif %}>Migliori risultati</option>
      <option value="date" {% if sort=='date' %}selected{% endif %}>Pi√π recenti (aggiornati)</option>
      <option value="added" {% if sort=='added' %}selected{% endif %}>Pi√π recenti (aggiunti)</option>
      <option value="price_asc" {% if sort=='price_asc' %}selected{% endif %}>Prezzo crescente</option>
      <option value="price_desc" {% if sort=='price_desc' %}selected{% endif %}>Prezzo decrescente</option>
    </select>

    <button type="submit" {% if scope=='tutti' %}disabled{% endif %}>Applica</button>
  </form>

  <div class="results-count">
    {{ risultati|length }} risultati trovati
  </div>

  <div class="grid">
    {% for r in risultati %}
    <div class="card" id="{{ r.hash }}">
      <button class="remove-btn" onclick="removeItem('{{ r.hash }}', '{{ r.title }}')">üóëÔ∏è</button>

      <!-- TRACK CLICK SICURO -->
      <a href="{{ r.url }}" target="_blank" rel="noopener"
         data-query="{{ query }}"
         data-title="{{ r.title }}"
         onclick="trackClick(event)">

        <img class="thumb" src="{{ r.image }}" alt="{{ r.title }}" loading="lazy" />
        <div class="title">{{ r.title }}</div>
        <div class="price">
          {% if r.price_display %}
            {{ r.price_display }}
          {% elif r.price_value %}
            {{ "%.2f"|format(r.price_value|float) }} EUR
          {% else %}
            Prezzo non disponibile
          {% endif %}
        </div>

        <div class="meta">
          {% if r.source %}
            <img class="logo" src="/static/loghi/{{ r.source|lower }}.png" alt="{{ r.source }}">
          {% endif %}
        </div>

      </a>
    </div>
    {% endfor %}
  </div>

  <div class="pagination">
    {% if page > 1 %}
      <a href="{{ url_for('search', q=query, era=era, vintage_class=vintage_class, category=category,
                      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page-1) }}">‚Üê Precedente</a>
    {% endif %}
    <span>Pagina {{ page }}</span>
    {% if risultati|length == 50 %}
      <a href="{{ url_for('search', q=query, era=era, vintage_class=vintage_class, category=category,
                      price_min=price_min, price_max=price_max, sort=sort, scope=scope, page=page+1) }}">Successiva ‚Üí</a>
    {% endif %}
  </div>

</div>

<!-- AUTO HEIGHT -->
<script>
function updateHeight() {
  const newH = document.body.scrollHeight;
  window.parent.postMessage({ rf_height: newH }, "*");
}
new ResizeObserver(updateHeight).observe(document.body);
updateHeight();
</script>

<!-- AUTO-LEARN: TRACK CLICK SICURO -->
<script>
function trackClick(event) {
    const el = event.currentTarget;
    const query = el.dataset.query || "";
    const title = el.dataset.title || "";

    fetch("/track_click", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query, title })
    });
}
</script>

<!-- MODALIT√Ä ADMIN -->
<script>
const urlParams = new URLSearchParams(window.location.search);
const isAdmin = urlParams.get("admin") === "1";

function enableAdminMode() {
  document.body.classList.add("admin-mode");
  document.querySelectorAll(".admin-only").forEach(el => el.style.display = "flex");
  document.querySelectorAll(".remove-btn").forEach(btn => btn.style.display = "block");
}

if (isAdmin) {
  document.addEventListener("DOMContentLoaded", enableAdminMode);
}

window.addEventListener("message", function(event) {
  if (event.data?.action === "enable-admin") {
    enableAdminMode();
  }
});
</script>

</body>
</html>
